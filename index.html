<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BDO Ship Upgrade Recipe Tracker</title>
    <script src="https://cdn.rawgit.com/brython-dev/brython/3.6.2/www/src/brython.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/brython-dev/brython/3.6.2/www/src/brython_stdlib.js" type="text/javascript"></script>
    <link href="css/layout.css" rel="stylesheet" type="text/css" />
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
</head>
<body onload="brython(1)">
    <section class="main">
        This site uses local storage to save your choices. <br /><br /><br />
        <b>Select a ship: </b></strong><span id="shiplist"></span><br /><br />
        <span id="shipparts"></span>
        <br /><span id="reset"></span>(warning not reversible)
    </section>
    <script type="text/python">
        from browser import document as doc
        from browser import html
        from browser.html import TABLE, TR, TH, TD, BR, H3, SPAN
        from browser.local_storage import storage
        from recipes import recipes
        from tradein import barters
        from vendor_items import items
        from ships import ships
        from information import gen_info

        # Given a part name, returns a string with information about that part
        # returns empty string if no information
        def notes(val):
            ret = []
            if val in items:
                for i in items[val]:
                    ret.append(i + BR())
            if val in recipes and val not in ships:
                for i in recipes[val]:
                    ret.append("Recipe: {}x {}".format(recipes[val][i], i) + BR())
            if val in barters:
                for c, item in enumerate(barters[val]["input"]):
                    ret.append("{} per {}".format(barters[val]['count'], item) + BR())
            return ret


        # update missing parts
        def update_missing():
            missing = {}
            for item in doc.select(".current"):
                count = int(item['data-max']) - int(doc[item['id']].value)
                if count:
                    if "+" not in item['data-name']:
                        missing[item['data-name']] = count
                    else:
                        count = 1
                    if item['data-name'] in ships:
                        continue

                    queue = [(item['data-name'], count)]
                    while queue:
                        current, c_count = queue.pop()
                        if current in recipes:

                            for i in recipes[current]:
                                n_count = c_count * recipes[current][i]
                                if "+" not in i:
                                    if i not in missing:
                                        missing[i] = 0
                                    missing[i] += n_count
                                queue.append((i, n_count))
                            if any(["+{} ".format(int(doc[item['id']].value)) in x or x.startswith("Epheria") for x in recipes[current]]):
                                queue = []

            t = TABLE(TR(TH("Count")+TH("Name")+TH("Notes")))

            for item in sorted(missing):
                t <= TR(TD(missing[item])+TD(item)+TD(notes(item)))

            doc['missing'].text = ''
            doc['missing'] <= t


        # Update the stored value of an item
        def update_count(ev):
            storage[ev.currentTarget['id']] = ev.currentTarget.value
            update(None)


        # Code to show an about page and miscellaneous information.
        def show_info():
            doc['shipparts'].text = ''
            doc['shipparts'] <= gen_info()
            return


        # Change what is displayed to match current selection
        def update(ev):
            if ev:
                storage['ship'] = ev.currentTarget.value
            eventname = storage['ship']
            if eventname == "Information":
                show_info()
                return
            # add green gear items for carracks
            recipesextra = {}
            for part in recipes[eventname].keys():
                id = "{}-{}".format(eventname, part)
                if '+' in part and part[4:] in recipes and (id not in storage or storage[id] == '0'):
                    for i in recipes[part[4:]]:
                        if "+" in i:
                            recipesextra[i] = 1
                            break

            t = TABLE()
            t <= TR(TH("Count") + TH("Max") + TH("Name"))
            ids = []
            for part in {**recipes[eventname], **recipesextra}:
                newid = "{}-{}".format(eventname, part)
                ids.append(newid)
                sel = html.SELECT(size=1, multiple=False, id=newid)
                val = 10 if '+' in part else recipes[eventname][part]
                sel['data-max'] = val
                sel['data-name'] = part
                sel['class'] = "current"
                sel.bind("change", update_count)
                for i in range(val+1):
                    sel <= html.OPTION(i)
                t <= TR(TD(sel) + TD(val) + TD("{} (select level)".format(part[4:]) if '+' in part else part))

            doc['shipparts'].text = ''
            doc['shipparts'] <= t
            doc['shipparts'] <= BR() + BR() + H3("Missing parts") + SPAN(id="missing")

            # iterate over selection boxes and set to values in local storage.
            for id in ids:
                if id in storage:
                    doc[id].value = storage[id]
            update_missing()


        # Initialize our list of ships and select the previous one if a choice exists
        def create_ship_list():
            sel = html.SELECT(size=1, multiple=False, id="ship")
            for ship in ships:
                sel <= html.OPTION(ship)
            sel.bind("change", update)
            doc['shiplist'] <= sel
            if 'ship' in storage and storage['ship'] in ships:
                doc['ship'].value = storage['ship']
            update(None)


        def reset_data(ev):
            for key in storage.keys():
                del storage[key]
            storage['ship'] = ships[0]
            doc['ship'].value = storage['ship']
            update(None)

        b_reset = html.BUTTON("Reset Data")
        b_reset.bind("click", reset_data)
        doc["reset"] <= b_reset
        create_ship_list()


    </script>

</body>
</html>